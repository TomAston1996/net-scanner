#  _   _      _    _____                                 
# | \ | |    | |  / ____|                                
# |  \| | ___| |_| (___   ___ __ _ _ __  _ __   ___ _ __ 
# | . ` |/ _ \ __|\___ \ / __/ _` | '_ \| '_ \ / _ \ '__|
# | |\  |  __/ |_ ____) | (_| (_| | | | | | | |  __/ |   
# |_| \_|\___|\__|_____/ \___\__,_|_| |_|_| |_|\___|_| 
'''
File: vuln_searcher.py
Brief: search for vulternabities based on CPE
Author: Tom Aston
'''
import os

from src.scan.iscanner import IScanner
from src.report.ireport_generator import IReportGenerator

from src.exploit.cpe_matcher import CpeMatcher
from src.types.types import HostInfo
from src.logger import Log

NVD_API_KEY = os.environ['NVD_API_KEY']

class VulnSearcher():
    '''
    Brief: class for scanning vulnerabilites based on CPE's found from CpeMatcher
    '''
    cpeMatcher = CpeMatcher()
    log = Log.get_instance()

    BASE_URL = 'https://services.nvd.nist.gov/rest/json/cves/2.0?'

    host_info = []

    def __init__(self, scanner: IScanner, report_generator: IReportGenerator):
        '''
        Brief: contructor method
        '''
        self.scanner = scanner
        self.report_generator = report_generator

    def scan_hosts(self) -> None:
        '''
        Brief: scan all hosts on the network for OS version, Open Ports etc.
        '''
        host_info: list[HostInfo] = self.scanner.get_host_info()
    
        self.host_info = host_info
    
    def output_host_report(self) -> bool:
        '''
        Brief: outputs a csv report based on active hosts on the network
        '''
        try:
            assert(len(self.host_info) != 0)
        except AssertionError as err:
            self.log.log_error(
                2, 
                "No host info available. Host scan must be run before report is created...", 
                self.__class__.__name__, 
                err, 
                ""
            )
            raise err
        
        self.report_generator.generate_host_report(self.host_info)

        return True

    def search_vulnerability_on_cpe_criteria(self) -> list[str]:
        '''
        Brief
        '''
        for host in self.host_info:
            for port in host['ports']:
                self.cpeMatcher.get_cpe_criteria_match(port['port_cpe'])

        #TODO use CVE api to get vulnerabilities based on CPE

    def list_to_txt(self, ls: list, file_name: str) -> None:
        '''
        Brief: dictionary to txt file
        '''
        with open(f'./local/{file_name}.txt', "w") as outfile:
            for item in ls:
                outfile.write(f'{str(item)}\n')

    
    
